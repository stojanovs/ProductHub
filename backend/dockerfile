FROM python:3.11-slim

ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

WORKDIR /app


# system deps required to build some Python packages (lxml, cryptography, etc.)
RUN apt-get update \
	&& DEBIAN_FRONTEND=noninteractive apt-get install -y \
	   gcc \
	   build-essential \
	   libxml2-dev \
	   libxslt1-dev \
	   libffi-dev \
	   python3-dev \
	&& rm -rf /var/lib/apt/lists/*

ARG INSTALL_HEAVY=0
ARG USE_WHEELS=0
COPY requirements-base.txt requirements-heavy.txt ./
# ensure up-to-date packaging tools, then install base requirements (heavy optional)
RUN pip install --upgrade pip setuptools wheel \
    && pip install --no-cache-dir -r requirements-base.txt \
    && if [ "${INSTALL_HEAVY}" = "1" ]; then \
         if [ "${USE_WHEELS}" = "1" ] && [ -d /wheels ]; then \
           pip install --no-index --find-links=/wheels -r requirements-heavy.txt; \
         else \
           pip install --no-cache-dir -r requirements-heavy.txt; \
         fi; \
       fi

COPY . .

EXPOSE 8000

CMD ["python", "manage.py", "runserver", "0.0.0.0:8000"]
